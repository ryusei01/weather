services:
  - type: web
    name: weather-django
    env: python
    buildCommand: |
      # 日本語フォントのインストール（WenQuanYi）
      mkdir -p ~/.fonts
      wget -P ~/.fonts https://github.com/evosystem-jp/heroku-buildpack-cjk-font/raw/master/fonts/wqy-microhei.ttc
      wget -P ~/.fonts https://github.com/evosystem-jp/heroku-buildpack-cjk-font/raw/master/fonts/wqy-zenhei.ttc
      # Pythonパッケージのインストール
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
      # Matplotlibのフォントキャッシュをクリア
      rm -rf ~/.cache/matplotlib
      # インストールされたフォントを確認
      echo "=== Installed fonts in ~/.fonts ==="
      ls -la ~/.fonts/
      echo "=== Font cache rebuild ==="
      python -c "import matplotlib.font_manager as fm; fm._load_fontmanager(try_read_cache=False); print('Font cache rebuilt')"
    startCommand: |
      export HOME=$(pwd)
      export FONTCONFIG_PATH="$(pwd)/.fonts"
      gunicorn weather_project.wsgi:application --bind 0.0.0.0:$PORT --timeout 120 --workers 2
