services:
  - type: web
    name: weather-django
    env: python
    buildCommand: |
      # 日本語フォントのインストール
      apt-get update && apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra fontconfig
      # カスタムフォントディレクトリを作成
      mkdir -p .fonts
      # IPAフォントをダウンロード（Noto CJKより確実）
      curl -LO https://moji.or.jp/wp-content/ipafont/IPAfont/IPAfont00303.zip
      unzip -o IPAfont00303.zip -d .fonts
      # フォントキャッシュを再構築
      fc-cache -fv .fonts
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
      # Matplotlibのフォントキャッシュをクリア
      rm -rf ~/.cache/matplotlib
      # インストールされたフォントを確認
      echo "=== Installed Japanese fonts ==="
      fc-list :lang=ja family | sort | uniq
      echo "=== IPA fonts in .fonts ==="
      ls -la .fonts/
      echo "=== Matplotlib font list rebuild ==="
      python -c "import matplotlib.font_manager as fm; fm._load_fontmanager(try_read_cache=False); print('Font cache rebuilt')"
    startCommand: |
      export HOME=$(pwd)
      export FONTCONFIG_PATH="$(pwd)/.fonts"
      gunicorn weather_project.wsgi:application --bind 0.0.0.0:$PORT --timeout 120 --workers 2
